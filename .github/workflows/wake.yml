name: Wake Up - Final Fix

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Script
        env:
          LINK_M: ${{ secrets.LINK_M }}
          LINK_S: ${{ secrets.LINK_S }}
          BOT_EMAIL: ${{ secrets.BOT_EMAIL }}
          BOT_PASSWORD: ${{ secrets.BOT_PASSWORD }}
        run: |
          python -c "
          import os
          import time
          from playwright.sync_api import sync_playwright

          def solve_login(page, email, password):
              print('>>> 1. 正在输入邮箱...')
              page.wait_for_selector('input[type=\"email\"]', state='visible')
              page.fill('input[type=\"email\"]', email)
              page.keyboard.press('Enter')
              time.sleep(3)

              # 处理“其他登录方式”或直接输密码
              if page.get_by_text('Use your password').is_visible():
                  page.get_by_text('Use your password').click()
                  time.sleep(2)

              print('>>> 2. 正在输入密码...')
              page.wait_for_selector('input[name=\"passwd\"]', state='visible')
              page.fill('input[name=\"passwd\"]', password)
              page.keyboard.press('Enter')
              time.sleep(5)

              # --- 核心修正：处理“保持登录”弹窗 ---
              print('>>> 3. 处理 [保持登录] 询问...')
              # 我们必须明确点击“否”，因为 GitHub 是公用环境
              # 按钮 ID 通常是 idBtn_Back (No) 或 idSIButton9 (Yes)
              try:
                  if page.locator('#idBtn_Back').is_visible():
                      print('   -> 点击 [否] (idBtn_Back)')
                      page.locator('#idBtn_Back').click()
                  elif page.locator('#idSIButton9').is_visible():
                      print('   -> 点击 [是] (idSIButton9)')
                      page.locator('#idSIButton9').click()
                  else:
                      print('   -> 未发现弹窗，尝试直接回车')
                      page.keyboard.press('Enter')
              except:
                  pass
              
              time.sleep(5)

          def run_flow(url_m, url_s, email, password):
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080},
                      record_video_dir='videos/'
                  )
                  page = context.new_page()
                  
                  try:
                      # 先登录
                      print('>>> 开始登录流程...')
                      page.goto('https://login.live.com/login.srf')
                      solve_login(page, email, password)

                      # 关键检查：如果跳到了帮助页面，强行拉回
                      if 'support.microsoft.com' in page.url:
                          print(' 警告：被重定向到了帮助页面，正在强行修正...')
                      
                      # --- 访问 M 问卷 ---
                      print(f'>>> 正在访问 M 问卷...')
                      page.goto(url_m, timeout=90000)
                      # 即使跳到登录页也再试一次（自动识别Session）
                      time.sleep(10)
                      if page.locator('canvas').is_visible():
                          print(' M 问卷加载成功！正在触底同步...')
                          page.mouse.click(960, 500)
                          page.keyboard.press('Control+End')
                          time.sleep(5)
                      else:
                          print(' M 问卷加载失败，截图留证')
                          page.screenshot(path='M_fail.png')

                      # --- 访问 S 问卷 ---
                      print(f'>>> 正在访问 S 问卷...')
                      page.goto(url_s, timeout=90000)
                      time.sleep(10)
                      if page.locator('canvas').is_visible():
                          print(' S 问卷加载成功！正在触底同步...')
                          page.mouse.click(960, 500)
                          page.keyboard.press('Control+End')
                          time.sleep(5)
                      else:
                          print(' S 问卷加载失败')

                  except Exception as e:
                      print(f' 运行异常: {e}')
                  finally:
                      context.close()
                      browser.close()

          run_flow(os.environ['LINK_M'], os.environ['LINK_S'], os.environ['BOT_EMAIL'], os.environ['BOT_PASSWORD'])
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-fix-video
          path: |
            videos/*.webm
            *.png
