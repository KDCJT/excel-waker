name: Wake Up - Cookie Injection

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Script with Cookies
        env:
          LINK_M: ${{ secrets.LINK_M }}
          LINK_S: ${{ secrets.LINK_S }}
          # 从 Secrets 读取 Cookie
          COOKIE_JSON: ${{ secrets.MS_COOKIES }}
        run: |
          python -c "
          import os
          import time
          import json
          from playwright.sync_api import sync_playwright

          def run_with_cookie(url, name, cookies_str):
              if not url:
                  print(f'❌ Error: [{name}] 未配置链接')
                  return

              print(f'>>> [{name}] 启动浏览器...')
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  
                  # 开启视频录制
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080},
                      record_video_dir='videos/'
                  )
                  
                  # ★★★ 核心步骤：注入 Cookie ★★★
                  try:
                      cookies = json.loads(cookies_str)
                      # 修正 Cookie 的 domain 和 path 问题，防止注入失败
                      # Playwright 对 cookie 格式要求较严，我们只保留核心字段
                      clean_cookies = []
                      for c in cookies:
                          clean_cookie = {
                              'name': c['name'],
                              'value': c['value'],
                              'domain': c['domain'],
                              'path': c['path']
                          }
                          clean_cookies.append(clean_cookie)
                      
                      context.add_cookies(clean_cookies)
                      print(f'>>> [{name}] ✅ Cookie 注入成功！身份已伪装。')
                  except Exception as e:
                      print(f'❌ Cookie 解析失败: {e}')
                      return

                  page = context.new_page()
                  
                  try:
                      print(f'>>> [{name}] 访问链接...')
                      page.goto(url, timeout=90000)
                      
                      # 等待加载
                      page.wait_for_selector('canvas', state='visible', timeout=60000)
                      time.sleep(10)
                      
                      # 截图：检查是否还有黄色警告条？
                      page.screenshot(path=f'{name}_1_login_check.png')
                      
                      # 检查是否登录成功 (寻找头像或没有 'Sign in' 按钮)
                      print(f'>>> [{name}] 检查登录状态...')
                      # 这里我们不管检测结果，直接执行同步操作，看视频就知道成没成

                      # --- 强制触底刷新 ---
                      print(f'>>> [{name}] 激活表格焦点...')
                      page.mouse.click(960, 500)
                      time.sleep(1)

                      print(f'>>> [{name}] 发送 Ctrl+End (强制同步)...')
                      page.keyboard.press('Control+End')
                      time.sleep(5)
                      
                      # 模拟光标活动
                      print(f'>>> [{name}] 保持活跃 30秒...')
                      for i in range(3):
                          page.keyboard.press('ArrowUp')
                          time.sleep(1)
                          page.keyboard.press('ArrowDown')
                          time.sleep(9)

                      print(f'>>> [{name}] 完成。')

                  except Exception as e:
                      print(f' Error: {e}')
                  finally:
                      context.close()
                      browser.close()
                      
                      # 保存视频
                      try:
                          files = os.listdir('videos')
                          for f in files:
                              if f.endswith('.webm') and name not in f:
                                  os.rename(os.path.join('videos', f), os.path.join('videos', f'{name}_cookie.webm'))
                                  print(f' 视频已保存: {name}_cookie.webm')
                                  break
                      except:
                          pass

          # 执行任务
          cookies = os.environ['COOKIE_JSON']
          run_with_cookie(os.environ['LINK_M'], 'M_Form', cookies)
          run_with_cookie(os.environ['LINK_S'], 'S_Form', cookies)
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cookie-debug
          path: |
            videos/*.webm
            *.png
