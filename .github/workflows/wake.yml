name: Wake Up - Double Click Fix

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Script
        env:
          LINK_M: ${{ secrets.LINK_M }}
          LINK_S: ${{ secrets.LINK_S }}
          BOT_EMAIL: ${{ secrets.BOT_EMAIL }}
          BOT_PASSWORD: ${{ secrets.BOT_PASSWORD }}
        run: |
          python -c "
          import os
          import time
          from playwright.sync_api import sync_playwright

          def solve_login(page, email, password):
              print('>>> [1/3] 正在进入登录页面...')
              page.goto('https://login.live.com/login.srf')
              
              # 输入邮箱
              page.wait_for_selector('input[type=\"email\"]')
              page.fill('input[type=\"email\"]', email)
              page.keyboard.press('Enter')
              time.sleep(3)

              # 如果有“使用密码”选项则点击
              if page.get_by_text('Use your password').is_visible():
                  page.get_by_text('Use your password').click()
                  time.sleep(2)

              # 输入密码
              page.wait_for_selector('input[name=\"passwd\"]')
              page.fill('input[name=\"passwd\"]', password)
              page.keyboard.press('Enter')
              
              # --- ★★★ 核心修复：Stay signed in 页面 ★★★ ---
              print('>>> [2/3] 正在处理 [Stay signed in?] 确认框...')
              time.sleep(5)
              
              # 截图 1：点击前（确认按钮位置）
              page.screenshot(path='debug_1_stay_signed_in_page.png')
              
              # 采用三重保险点击 'Yes'
              try:
                  # 1. 优先通过角色和名称点击（最精准，不会点到旁边的 Learn More）
                  yes_btn = page.get_by_role('button', name=['Yes', '是'])
                  if yes_btn.is_visible():
                      print('   -> 发现 [Yes] 按钮，执行角色点击')
                      yes_btn.click(force=True)
                  else:
                      # 2. 备选：通过 ID 强行物理点击中心
                      print('   -> 未发现角色按钮，尝试 ID 定位')
                      page.locator('#idSIButton9').click(force=True)
              except Exception as e:
                  print(f'   -> 点击异常: {e}，尝试键盘回车')
                  # 3. 终极备份：直接敲回车
                  page.keyboard.press('Enter')
              
              # 给 10 秒跳转时间
              time.sleep(10)
              page.screenshot(path='debug_2_after_login_attempt.png')

          def sync_excel(page, url, name):
              print(f'>>> [3/3] 正在同步表格: {name}')
              page.goto(url, timeout=120000)
              
              # 等待插件加载
              time.sleep(20)
              page.screenshot(path=f'debug_3_{name}_loaded.png')

              # 检查并点击黄条内的 'Please sign in'
              signin_link = page.get_by_text('Please sign in')
              if signin_link.is_visible():
                  print('    检测到黄条，执行点击同步...')
                  try:
                      signin_link.first.click(force=True)
                      time.sleep(10)
                      page.reload() # 刷新网页是激活同步的良药
                      time.sleep(15)
                  except:
                      pass

              # 触底同步动作
              if page.locator('canvas').is_visible():
                  print('   -> 正在执行 Control+End 强制写入')
                  page.mouse.click(960, 500)
                  time.sleep(2)
                  page.keyboard.press('Control+End')
                  time.sleep(10)
                  print(f'    {name} 同步成功')
              else:
                  print(f'    {name} 页面渲染失败')

          def main():
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080},
                      record_video_dir='videos/'
                  )
                  page = context.new_page()
                  
                  try:
                      solve_login(page, os.environ['BOT_EMAIL'], os.environ['BOT_PASSWORD'])
                      sync_excel(page, os.environ['LINK_M'], 'M_Form')
                      sync_excel(page, os.environ['LINK_S'], 'S_Form')
                  except Exception as e:
                      print(f' 崩溃: {e}')
                  finally:
                      context.close()
                      browser.close()

          main()
          "

      - name: Upload Debug Results
        # 即使失败也上传截图和视频
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-debug-results
          path: |
            videos/*.webm
            *.png
