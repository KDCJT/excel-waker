name: Wake Up - Pre-Login

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Script
        env:
          LINK_M: ${{ secrets.LINK_M }}
          LINK_S: ${{ secrets.LINK_S }}
          BOT_EMAIL: ${{ secrets.BOT_EMAIL }}
          BOT_PASSWORD: ${{ secrets.BOT_PASSWORD }}
        run: |
          python -c "
          import os
          import time
          from playwright.sync_api import sync_playwright

          def run_pre_login_sync(url_m, url_s, email, password):
              print(f'>>> 启动浏览器...')
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  # 开启录像，记录全过程
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080},
                      record_video_dir='videos/'
                  )
                  page = context.new_page()
                  
                  try:
                      # --- 步骤 1: 先去微软官网登录 ---
                      print('>>> 1. 访问 login.live.com 进行全局登录...')
                      page.goto('https://login.live.com/login.srf', timeout=60000)
                      
                      # 等待邮箱输入框
                      page.wait_for_selector('input[type=\"email\"]', state='visible')
                      print('   -> 输入邮箱...')
                      page.fill('input[type=\"email\"]', email)
                      page.click('input[type=\"submit\"]')
                      time.sleep(2)
                      
                      # 等待密码输入框
                      print('   -> 输入密码...')
                      page.fill('input[type=\"password\"]', password)
                      page.click('input[type=\"submit\"]')
                      time.sleep(3)
                      
                      # 处理 '保持登录'
                      print('   -> 确认保持登录...')
                      try:
                          if page.get_by_text('Stay signed in?').count() > 0:
                              page.click('input[id=\"idSIButton9\"]')
                          elif page.get_by_text('No').count() > 0:
                              page.click('input[id=\"idBtn_Back\"]') # 或者点 No
                      except:
                          pass
                      
                      page.wait_for_load_state('networkidle')
                      print('>>> ✅ 微软账号登录完成！')
                      time.sleep(3)


                      # --- 步骤 2: 带着登录状态去访问 M 问卷 ---
                      print(f'>>> 2. 访问 M 问卷 (应该自动已登录)...')
                      page.goto(url_m, timeout=90000)
                      
                      # 等待 Excel 加载
                      page.wait_for_selector('canvas', state='visible', timeout=60000)
                      time.sleep(10)
                      
                      # 截图验证：此时应该没有黄条了
                      page.screenshot(path='M_Form_Logged_In.png')

                      # 强制同步操作
                      print('   -> 激活焦点并触底刷新...')
                      page.mouse.click(960, 500)
                      time.sleep(1)
                      page.keyboard.press('Control+End')
                      time.sleep(5)
                      
                      # 保持活跃
                      for i in range(3):
                          page.keyboard.press('ArrowUp')
                          time.sleep(5)


                      # --- 步骤 3: 接着访问 S 问卷 ---
                      print(f'>>> 3. 访问 S 问卷...')
                      page.goto(url_s, timeout=90000)
                      
                      page.wait_for_selector('canvas', state='visible', timeout=60000)
                      time.sleep(10)
                      
                      page.screenshot(path='S_Form_Logged_In.png')
                      
                      print('   -> 激活焦点并触底刷新...')
                      page.mouse.click(960, 500)
                      time.sleep(1)
                      page.keyboard.press('Control+End')
                      time.sleep(5)
                      
                      for i in range(3):
                          page.keyboard.press('ArrowUp')
                          time.sleep(5)

                      print('>>>  所有任务完成。')

                  except Exception as e:
                      print(f' Error: {e}')
                  finally:
                      context.close()
                      browser.close()
                      
                      # 重命名视频
                      try:
                          files = os.listdir('videos')
                          for f in files:
                              if f.endswith('.webm'):
                                  os.rename(os.path.join('videos', f), os.path.join('videos', 'full_process.webm'))
                      except:
                          pass

          run_pre_login_sync(
              os.environ['LINK_M'], 
              os.environ['LINK_S'], 
              os.environ['BOT_EMAIL'], 
              os.environ['BOT_PASSWORD']
          )
          "

      - name: Upload Debug Evidence
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pre-login-evidence
          path: |
            videos/*.webm
            *.png
