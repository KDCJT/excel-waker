name: Wake Up - Absolute Sync Fix

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Script
        env:
          LINK_M: ${{ secrets.LINK_M }}
          LINK_S: ${{ secrets.LINK_S }}
          BOT_EMAIL: ${{ secrets.BOT_EMAIL }}
          BOT_PASSWORD: ${{ secrets.BOT_PASSWORD }}
        run: |
          python -c "
          import os
          import time
          from playwright.sync_api import sync_playwright

          def solve_login(page, email, password):
              print('>>> [1/3] 正在登录微软账号...')
              page.goto('https://login.live.com/login.srf')
              
              # 输入邮箱
              page.wait_for_selector('input[type=\"email\"]')
              page.fill('input[type=\"email\"]', email)
              page.keyboard.press('Enter')
              time.sleep(3)

              # 处理可能的“选择登录方式”
              if page.get_by_text('Use your password').is_visible():
                  page.get_by_text('Use your password').click()
                  time.sleep(2)

              # 输入密码
              page.wait_for_selector('input[name=\"passwd\"]')
              page.fill('input[name=\"passwd\"]', password)
              print('   -> 密码已填入，正在提交...')
              page.keyboard.press('Enter')
              time.sleep(5)

              # 处理“保持登录” (视频卡点)
              print('>>> [2/3] 处理 [Stay signed in?] 确认框...')
              # 采用更强力的选择器：尝试点击 'Yes' 按钮
              try:
                  # 按钮 ID 是 idSIButton9，但我们配合 text 确保万无一失
                  yes_button = page.locator('input#idSIButton9, input[value=\"Yes\"], input[value=\"是\"]')
                  if yes_button.first.is_visible():
                      yes_button.first.click(force=True)
                      print('   -> 已强制点击 [Yes]')
                  else:
                      page.keyboard.press('Enter')
                      print('   -> 未发现按钮，尝试回车')
              except:
                  page.keyboard.press('Enter')
              
              # 给一点跳转缓冲时间
              time.sleep(10)

          def sync_excel_force(page, url, name):
              print(f'>>> [3/3] 正在进入 {name} 强制唤醒...')
              page.goto(url, timeout=120000)
              
              # 等待 15 秒让 Excel 内部插件加载
              time.sleep(15)
              
              # 检查黄色警告条 (Only signed in users can sync with Forms)
              # 这是导致数据不更新的唯一原因
              warning_selector = 'text=\"Only signed in users can sync with Forms\"'
              signin_link_selector = 'text=\"Please sign in\"'
              
              for attempt in range(3):
                  print(f'   -> 检查同步状态 (尝试 {attempt+1})...')
                  if page.get_by_text('Only signed in users').is_visible():
                      print('   ⚠️ 发现同步警告条！正在点击内部 [Please sign in] 链接...')
                      try:
                          # 寻找警告条里的登录链接并点击
                          page.get_by_text('Please sign in').first.click(force=True)
                          print('   -> 已点击警告链接，等待 15 秒让数据写回...')
                          time.sleep(15)
                          # 如果点击后弹出了新的小窗口，这里会自动处理或忽略
                      except:
                          print('   -> 点击警告链接失败，尝试刷新页面...')
                          page.reload()
                          time.sleep(10)
                  else:
                      print('    未发现同步警告，Session 已被识别！')
                      break

              # 执行触底操作 (确保触发写入)
              if page.locator('canvas').is_visible():
                  print('   -> 激活表格焦点并执行 [Control+End]...')
                  # 点击表格中心点
                  page.mouse.click(960, 500)
                  time.sleep(1)
                  page.keyboard.press('Control+End')
                  time.sleep(10)
                  print(f'    {name} 同步流程执行完毕')
              else:
                  print(f'    {name} 页面加载异常，截图中...')
                  page.screenshot(path=f'{name}_error.png')

          def run_main():
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080},
                      record_video_dir='videos/'
                  )
                  page = context.new_page()
                  
                  try:
                      solve_login(page, os.environ['BOT_EMAIL'], os.environ['BOT_PASSWORD'])
                      
                      # 依次处理两份表
                      sync_excel_force(page, os.environ['LINK_M'], 'M_Form')
                      sync_excel_force(page, os.environ['LINK_S'], 'S_Form')

                  except Exception as e:
                      print(f' 脚本运行崩溃: {e}')
                  finally:
                      context.close()
                      browser.close()

          run_main()
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sync-fix-results
          path: |
            videos/*.webm
            *.png
