name: Wake Up - Forced Login

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Script
        env:
          LINK_M: ${{ secrets.LINK_M }}
          LINK_S: ${{ secrets.LINK_S }}
          BOT_EMAIL: ${{ secrets.BOT_EMAIL }}
          BOT_PASSWORD: ${{ secrets.BOT_PASSWORD }}
        run: |
          python -c "
          import os
          import time
          from playwright.sync_api import sync_playwright

          def force_login_sync(url, name, email, password):
              print(f'>>> [{name}] 启动...')
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  # 开启视频录制
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080},
                      record_video_dir='videos/'
                  )
                  page = context.new_page()
                  
                  try:
                      print(f'>>> [{name}] 访问链接...')
                      page.goto(url, timeout=90000)
                      time.sleep(5)
                      
                      # 1. 检测并处理登录
                      # 因为是特定分享，微软一定会跳转到 login.live.com
                      if 'login.live' in page.url or page.locator('input[type=\"email\"]').count() > 0:
                          print(f'>>> [{name}] 检测到登录页，开始登录...')
                          
                          # 输入邮箱
                          page.fill('input[type=\"email\"]', email)
                          page.click('input[type=\"submit\"]')
                          time.sleep(2)
                          
                          # 输入密码
                          if page.locator('input[type=\"password\"]').count() > 0:
                              print(f'>>> [{name}] 输入密码...')
                              page.fill('input[type=\"password\"]', password)
                              page.click('input[type=\"submit\"]')
                              time.sleep(2)
                          
                          # 保持登录
                          if page.get_by_text('Stay signed in?').count() > 0 or page.get_by_text('保持登录状态').count() > 0:
                              print(f'>>> [{name}] 点击保持登录...')
                              try:
                                  page.click('input[id=\"idSIButton9\"]')
                              except:
                                  page.keyboard.press('Enter')
                          
                          print(f'>>> [{name}] 登录提交完成，等待跳转...')
                          page.wait_for_load_state('networkidle')
                          time.sleep(15)

                      # 2. 确认进入 Excel
                      try:
                          page.wait_for_selector('canvas', state='visible', timeout=60000)
                          print(f'>>> [{name}]  成功进入 Excel！')
                      except:
                          print(f'>>> [{name}]  未检测到表格，可能登录失败或需要验证码。')
                          # 截图留证
                          page.screenshot(path=f'{name}_fail.png')
                          return

                      # 3. 强制同步 (Ctrl+End)
                      print(f'>>> [{name}] 激活表格并同步...')
                      page.mouse.click(960, 500)
                      time.sleep(1)
                      
                      page.keyboard.press('Control+End')
                      print(f'>>> [{name}] 已发送触底指令')
                      time.sleep(5)
                      
                      # 4. 保持连接
                      print(f'>>> [{name}] 保持在线 30秒...')
                      for i in range(3):
                          time.sleep(10)
                          page.mouse.move(960, 500 + i*10)

                      print(f'>>> [{name}] 完成。')

                  except Exception as e:
                      print(f' Critical Error: {e}')
                  finally:
                      context.close()
                      browser.close()
                      
                      # 保存视频
                      try:
                          files = os.listdir('videos')
                          for f in files:
                              if f.endswith('.webm') and name not in f:
                                  os.rename(os.path.join('videos', f), os.path.join('videos', f'{name}_force.webm'))
                      except:
                          pass

          force_login_sync(os.environ['LINK_M'], 'M_Form', os.environ['BOT_EMAIL'], os.environ['BOT_PASSWORD'])
          force_login_sync(os.environ['LINK_S'], 'S_Form', os.environ['BOT_EMAIL'], os.environ['BOT_PASSWORD'])
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: debug-results
          path: |
            videos/*.webm
            *.png
