name: Wake Up - Double Auth Fix

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Script
        env:
          LINK_M: ${{ secrets.LINK_M }}
          LINK_S: ${{ secrets.LINK_S }}
          BOT_EMAIL: ${{ secrets.BOT_EMAIL }}
          BOT_PASSWORD: ${{ secrets.BOT_PASSWORD }}
        run: |
          python -c "
          import os
          import time
          from playwright.sync_api import sync_playwright

          def solve_login(page, email, password):
              print('>>> 1. 输入邮箱...')
              page.wait_for_selector('input[type=\"email\"]', state='visible')
              page.fill('input[type=\"email\"]', email)
              page.keyboard.press('Enter')
              time.sleep(4)

              # 处理“Sign in another way”
              if page.get_by_text('Use your password').is_visible():
                  print('   -> 切换到密码模式')
                  page.get_by_text('Use your password').click()
                  time.sleep(2)

              print('>>> 2. 输入密码...')
              page.wait_for_selector('input[name=\"passwd\"]', state='visible')
              page.fill('input[name=\"passwd\"]', password)
              page.keyboard.press('Enter')
              time.sleep(6)

              # 处理“Stay signed in?” (视频 00:07 处)
              print('>>> 3. 处理保持登录状态...')
              # 点击 'Yes' 按钮以维持 Session 活性
              if page.locator('#idSIButton9').is_visible():
                  print('   -> 点击 [Yes]')
                  page.locator('#idSIButton9').click()
              else:
                  print('   -> 未发现按钮，尝试回车')
                  page.keyboard.press('Enter')
              
              time.sleep(8)

          def sync_excel(page, url, name):
              print(f'>>> 正在加载 {name} ...')
              page.goto(url, timeout=120000)
              time.sleep(15)

              # 核心修正：处理 Excel 内部的黄色警告条 (视频 00:23 处)
              # 文字通常是 'Only signed in users can sync with Forms. Please sign in...'
              warning_text = 'Only signed in users can sync with Forms'
              if page.get_by_text(warning_text).is_visible():
                  print(f'⚠️ 发现黄色警告条！尝试在 Excel 内部授权...')
                  try:
                      # 寻找并点击警告条里的 'Please sign in' 链接
                      page.get_by_text('Please sign in').click()
                      print('   -> 已点击警告条内部登录链接，等待刷新...')
                      time.sleep(15)
                  except:
                      pass

              # 执行触底操作
              if page.locator('canvas').is_visible():
                  print(f' {name} 加载成功，执行同步动作...')
                  page.mouse.click(960, 500)
                  time.sleep(1)
                  page.keyboard.press('Control+End')
                  time.sleep(5)
                  # 模拟活跃
                  for _ in range(3):
                      page.keyboard.press('ArrowUp')
                      time.sleep(5)
              else:
                  print(f' {name} 表格未出现')
                  page.screenshot(path=f'{name}_error.png')

          def run_main():
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080},
                      record_video_dir='videos/'
                  )
                  page = context.new_page()
                  
                  try:
                      print('>>> 开始统一登录...')
                      page.goto('https://login.live.com/login.srf')
                      solve_login(page, os.environ['BOT_EMAIL'], os.environ['BOT_PASSWORD'])

                      # 如果被踢到帮助页面，这行代码会自动把我们带回 Excel 链接
                      sync_excel(page, os.environ['LINK_M'], 'M_Form')
                      sync_excel(page, os.environ['LINK_S'], 'S_Form')

                      print('>>>  流程全部执行完毕')

                  except Exception as e:
                      print(f' 报错: {e}')
                  finally:
                      context.close()
                      browser.close()

          run_main()
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auth-fix-result
          path: |
            videos/*.webm
            *.png
