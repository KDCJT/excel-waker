name: Wake Up - Auto Login

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Login & Sync
        env:
          # 你的文件链接
          LINK_M: ${{ secrets.LINK_M }}
          LINK_S: ${{ secrets.LINK_S }}
          # 工具人账号密码
          BOT_EMAIL: ${{ secrets.BOT_EMAIL }}
          BOT_PASSWORD: ${{ secrets.BOT_PASSWORD }}
        run: |
          python -c "
          import os
          import time
          from playwright.sync_api import sync_playwright

          def login_and_sync(url, name, p_email, p_password):
              if not url:
                  print(f'❌ Error: [{name}] 未配置链接')
                  return

              print(f'>>> [{name}] 启动浏览器 (登录模式)...')
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  # 开启视频录制，看看登录成功没
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080},
                      record_video_dir='videos/'
                  )
                  page = context.new_page()
                  
                  try:
                      print(f'>>> [{name}] 访问链接，等待跳转登录页...')
                      page.goto(url, timeout=90000)
                      time.sleep(5)

                      # --- 阶段 1: 处理登录 ---
                      # 检查是否跳转到了 login.live.com
                      if 'login' in page.url or page.locator('input[type=\"email\"]').count() > 0:
                          print(f'>>> [{name}] 检测到登录页，开始自动登录...')
                          
                          # 1. 输入邮箱
                          page.fill('input[type=\"email\"]', p_email)
                          page.click('input[type=\"submit\"]') # 点击下一步
                          time.sleep(2)
                          
                          # 2. 输入密码
                          print(f'>>> [{name}] 输入密码...')
                          page.fill('input[type=\"password\"]', p_password)
                          page.click('input[type=\"submit\"]') # 点击登录
                          time.sleep(3)
                          
                          # 3. 处理 '保持登录' 弹窗 (有时候会出现)
                          if page.get_by_text('Stay signed in?').count() > 0 or page.get_by_text('保持登录状态').count() > 0:
                              print(f'>>> [{name}] 点击保持登录...')
                              # 点击 'Yes' 或 'No' 都可以，这里选 Yes
                              try:
                                  page.click('input[id=\"idSIButton9\"]') 
                              except:
                                  page.keyboard.press('Enter')
                          
                          print(f'>>> [{name}] 登录操作完成，等待跳转 Excel...')
                          page.wait_for_load_state('networkidle')
                          time.sleep(10)
                      
                      else:
                          print(f'>>> [{name}] 似乎没有跳转登录页？当前URL: {page.url}')

                      # --- 阶段 2: 确认进入 Excel ---
                      print(f'>>> [{name}] 等待 Excel 加载...')
                      try:
                          page.wait_for_selector('canvas', state='visible', timeout=60000)
                          print(f'>>> [{name}] ✅ 登录成功！Excel 已加载！')
                      except:
                          print(f'>>> [{name}] ❌ 加载超时，可能登录被拦截或需要验证码。')
                          page.screenshot(path=f'{name}_login_fail.png')
                          raise Exception('Login Failed')

                      # --- 阶段 3: 强制同步 ---
                      # 此时我们已经是登录用户了，微软会允许同步
                      print(f'>>> [{name}] 激活表格焦点...')
                      page.mouse.click(960, 500)
                      time.sleep(1)

                      print(f'>>> [{name}] 触发同步 (Ctrl+End)...')
                      page.keyboard.press('Control+End')
                      time.sleep(5)
                      
                      print(f'>>> [{name}] 模拟人工查阅 30秒...')
                      for i in range(3):
                          page.keyboard.press('ArrowUp')
                          time.sleep(1)
                          page.keyboard.press('ArrowDown')
                          time.sleep(9)

                      print(f'>>> [{name}] 完成。')

                  except Exception as e:
                      print(f' Error: {e}')
                  finally:
                      context.close()
                      browser.close()
                      
                      # 保存视频
                      try:
                          files = os.listdir('videos')
                          for f in files:
                              if f.endswith('.webm') and name not in f:
                                  os.rename(os.path.join('videos', f), os.path.join('videos', f'{name}_login.webm'))
                                  print(f' 视频已保存: {name}_login.webm')
                                  break
                      except:
                          pass

          login_and_sync(
              os.environ['LINK_M'], 
              'M_Form', 
              os.environ['BOT_EMAIL'], 
              os.environ['BOT_PASSWORD']
          )
          
          login_and_sync(
              os.environ['LINK_S'], 
              'S_Form', 
              os.environ['BOT_EMAIL'], 
              os.environ['BOT_PASSWORD']
          )
          "

      - name: Upload Videos & Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: login-debug
          path: |
            videos/*.webm
            *.png
