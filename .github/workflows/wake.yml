name: Wake Up - Physical Mouse Click

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Script
        env:
          LINK_M: ${{ secrets.LINK_M }}
          LINK_S: ${{ secrets.LINK_S }}
          BOT_EMAIL: ${{ secrets.BOT_EMAIL }}
          BOT_PASSWORD: ${{ secrets.BOT_PASSWORD }}
        run: |
          python -c "
          import os
          import time
          from playwright.sync_api import sync_playwright

          def solve_login_physical(page, email, password):
              print('>>> [1/3] 正在登录微软账号...')
              page.goto('https://login.live.com/login.srf')
              
              page.wait_for_selector('input[type=\"email\"]')
              page.fill('input[type=\"email\"]', email)
              page.keyboard.press('Enter')
              time.sleep(4)

              # 处理可能的密码模式切换
              if page.get_by_text('Use your password').is_visible():
                  page.get_by_text('Use your password').click()
                  time.sleep(2)

              page.wait_for_selector('input[name=\"passwd\"]')
              page.fill('input[name=\"passwd\"]', password)
              page.keyboard.press('Enter')
              
              # --- 核心改进：物理模拟点击 Stay Signed In ---
              print('>>> [2/3] 等待 [Stay signed in?] 页面稳定...')
              # 等待那个 ID 为 idSIButton9 的按钮（Yes按钮）
              try:
                  btn = page.wait_for_selector('#idSIButton9', timeout=15000)
                  if btn:
                      # 获取按钮的物理坐标
                      box = btn.bounding_box()
                      if box:
                          print(f'   -> 发现按钮位置: x={box[\"x\"]}, y={box[\"y\"]}')
                          # 模拟真人鼠标移动到按钮中心
                          center_x = box['x'] + box['width'] / 2
                          center_y = box['y'] + box['height'] / 2
                          page.mouse.move(center_x, center_y)
                          time.sleep(1)
                          # 物理压下鼠标并抬起，模拟最真实的点击
                          page.mouse.down()
                          time.sleep(0.1)
                          page.mouse.up()
                          print('   -> 已执行物理坐标点击 [Yes]')
                      else:
                          page.keyboard.press('Enter')
              except:
                  print('   -> 没等到按钮，尝试盲敲回车...')
                  page.keyboard.press('Enter')
              
              time.sleep(10)

          def force_sync_internal(page, url, name):
              print(f'>>> [3/3] 访问 {name} ...')
              page.goto(url, wait_until='networkidle', timeout=120000)
              time.sleep(20)

              # 核心卡点：Excel 内部的黄色警告条
              # 有时候我们需要点击两次才能彻底激活
              for i in range(2):
                  signin_btn = page.get_by_text('Please sign in')
                  if signin_btn.is_visible():
                      print(f'    警告：检测到黄条，尝试内部激活 ({i+1})...')
                      # 获取黄条按钮坐标进行物理点击
                      try:
                          box = signin_btn.first.bounding_box()
                          if box:
                              page.mouse.click(box['x'] + 5, box['y'] + 5)
                              print('   -> 物理点击了 [Please sign in]')
                              time.sleep(15)
                              page.reload() # 刷新通常是激活 Session 的神方
                              time.sleep(15)
                      except:
                          pass

              # 触底同步动作
              if page.locator('canvas').is_visible():
                  print('   -> 激活表格执行 Control+End...')
                  page.mouse.click(960, 500)
                  time.sleep(2)
                  page.keyboard.press('Control+End')
                  time.sleep(10)
                  # 模拟活跃防止断线
                  page.keyboard.press('ArrowDown')
                  time.sleep(5)
                  print(f'    {name} 同步指令已发出')
              else:
                  print(f'    {name} 页面未加载 Canvas')

          def main():
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080},
                      record_video_dir='videos/'
                  )
                  page = context.new_page()
                  try:
                      solve_login_physical(page, os.environ['BOT_EMAIL'], os.environ['BOT_PASSWORD'])
                      force_sync_internal(page, os.environ['LINK_M'], 'M_Form')
                      force_sync_internal(page, os.environ['LINK_S'], 'S_Form')
                  except Exception as e:
                      print(f' 运行异常: {e}')
                  finally:
                      context.close()
                      browser.close()

          main()
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: physical-click-results
          path: |
            videos/*.webm
            *.png
