name: Wake Up - Mouse Wheel Storm

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Interaction Script
        env:
          LINK_M: "https://1drv.ms/x/c/a4392b0288bb7160/IQDctShyo6lYSanQd1pAX_8IAdX34egaBn8Su4iZFvE0THU?e=rlX9hX"
          LINK_S: "https://1drv.ms/x/c/a4392b0288bb7160/IQAtSyDI_-NSSZUokHEGwPeNAQ0sOJutcZ9dYJUh1p2qpBE?e=sIzrB1"
        run: |
          python -c "
          import os
          import time
          from playwright.sync_api import sync_playwright

          def wheel_storm(url, name):
              print(f'>>> [{name}] 启动浏览器...')
              with sync_playwright() as p:
                  # 启动浏览器，设置较大的视口以便显示更多行
                  browser = p.chromium.launch(headless=True)
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080}
                  )
                  page = context.new_page()
                  
                  try:
                      print(f'>>> [{name}] 加载网页...')
                      page.goto(url, timeout=90000)
                      page.wait_for_selector('canvas', state='visible', timeout=60000)
                      print(f'>>> [{name}] 网格就绪，等待渲染...')
                      time.sleep(15)

                      # 1. 截图：初始状态
                      page.screenshot(path=f'{name}_1_entry.png')

                      # 2. 将鼠标移动到表格中心位置
                      # Excel Online 的表格区域通常占据屏幕大部分
                      center_x = 960
                      center_y = 600
                      print(f'>>> [{name}] 鼠标悬停在 ({center_x}, {center_y})')
                      page.mouse.move(center_x, center_y)
                      page.mouse.click(center_x, center_y) # 点一下确保激活
                      time.sleep(1)

                      # 3. 开启滚轮风暴
                      print(f'>>> [{name}] 启动鼠标滚轮风暴 (强制加载数据)...')
                      
                      # 循环 15 次，每次大幅度滚动
                      for i in range(15):
                          # delta_y=5000 表示一次滚动的像素距离，相当于猛搓一下滚轮
                          page.mouse.wheel(0, 5000)
                          print(f'     滚轮冲击第 {i+1} 次...')
                          
                          # 每次滚动后必须等待，因为 Excel 需要时间去服务器拉取新行的数据 (Lazy Load)
                          # 如果不等，滚轮信号会被忽略
                          time.sleep(2) 
                          
                          # 配合键盘辅助
                          if i % 3 == 0:
                              page.keyboard.press('End')

                      # 4. 截图：风暴后的状态 (检查行号是否变化)
                      page.screenshot(path=f'{name}_2_scrolled.png')

                      # 5. 最后保持连接 30 秒，确保最后加载的数据写入硬盘
                      print(f'>>> [{name}] 保持连接 30秒...')
                      # 稍微晃动鼠标防断连
                      for i in range(3):
                          time.sleep(10)
                          page.mouse.move(center_x, center_y + i*10)

                      print(f'>>> [{name}] 完成。')

                  except Exception as e:
                      print(f' Error: {e}')
                      try:
                          page.screenshot(path=f'{name}_error.png')
                      except:
                          pass
                  finally:
                      browser.close()

          wheel_storm(os.environ['LINK_M'], 'M_Form')
          wheel_storm(os.environ['LINK_S'], 'S_Form')
          "

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: wheel-screenshots
          path: "*.png"
