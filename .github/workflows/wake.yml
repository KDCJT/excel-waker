name: Wake Up - Edit Mode (Secret)

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  playwright-wake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Interaction Script
        env:
          # ★★★ 关键：从 Secrets 读取链接，不暴露在代码中 ★★★
          LINK_M: ${{ secrets.LINK_M }}
          LINK_S: ${{ secrets.LINK_S }}
        run: |
          python -c "
          import os
          import time
          from playwright.sync_api import sync_playwright

          def edit_mode_sync(url, name):
              # 如果 Secrets 没配置，打印错误并退出
              if not url:
                  print(f' Error: [{name}] 未配置 Secret 链接！')
                  return

              print(f'>>> [{name}] 启动浏览器 (编辑模式)...')
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      viewport={'width': 1920, 'height': 1080}
                  )
                  page = context.new_page()
                  
                  try:
                      print(f'>>> [{name}] 正在打开编辑链接...')
                      page.goto(url, timeout=90000)
                      
                      # 编辑模式加载比较慢，需要等待 Excel UI 出现
                      # 我们等待 'canvas' 或者编辑栏 'FormulaBar'
                      print(f'>>> [{name}] 等待 Excel 编辑器加载...')
                      page.wait_for_selector('canvas', state='visible', timeout=60000)
                      time.sleep(15) 

                      # 1. 截图：确认进入了编辑界面
                      page.screenshot(path=f'{name}_1_editor.png')

                      # 2. 激活焦点 (点击表格中心)
                      print(f'>>> [{name}] 激活表格...')
                      page.mouse.click(960, 500)
                      time.sleep(1)

                      # 3. 强制触底刷新 (触发同步的核心)
                      # 因为是编辑模式，光标跳转会强制后台拉取数据
                      print(f'>>> [{name}] 发送 Ctrl+End 跳到数据末尾...')
                      page.keyboard.press('Control+End')
                      time.sleep(5)
                      
                      # 4. 模拟人工编辑动作 (但不真的修改数据)
                      # 只是上下左右移动光标，告诉服务器'我在线，我要看最新数据'
                      print(f'>>> [{name}] 模拟光标活动 (Ping Server)...')
                      for i in range(5):
                          page.keyboard.press('ArrowUp')
                          time.sleep(0.5)
                          page.keyboard.press('ArrowDown')
                          time.sleep(0.5)

                      # 5. 截图：确认到底
                      page.screenshot(path=f'{name}_2_bottom.png')

                      # 6. 保持连接 45 秒
                      print(f'>>> [{name}] 保持编辑会话在线 45秒...')
                      for i in range(5):
                          time.sleep(9)
                          # 稍微动一下鼠标防止掉线
                          page.mouse.move(960, 500 + i*10)

                      print(f'>>> [{name}] 同步完成。')

                  except Exception as e:
                      print(f' Error: {e}')
                      try:
                          page.screenshot(path=f'{name}_error.png')
                      except:
                          pass
                  finally:
                      browser.close()

          edit_mode_sync(os.environ['LINK_M'], 'M_Form')
          edit_mode_sync(os.environ['LINK_S'], 'S_Form')
          "

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: edit-mode-screenshots
          path: "*.png"
